import asyncio
import logging
import random
import time
import psutil
import config
import os
import io
from ChatBot import _boot_
from ChatBot import get_readable_time
from ChatBot.mplugin.helpers import is_owner
from ChatBot import mongo
from datetime import datetime
from pymongo import MongoClient
from pyrogram.enums import ChatType
from pyrogram import Client, filters
from ChatBot import CLONE_OWNERS, db
from config import OWNER_ID, MONGO_URL, OWNER_USERNAME
from pyrogram.errors import FloodWait, ChatAdminRequired
from ChatBot.database.chats import get_served_chats, add_served_chat
from ChatBot.database.users import get_served_users, add_served_user
from ChatBot.database.clonestats import get_served_cchats, get_served_cusers, add_served_cuser, add_served_cchat
from pyrogram.types import InlineKeyboardButton, InlineKeyboardMarkup, Message, CallbackQuery
from ChatBot.mplugin.helpers import (
    START,
    START_BOT,
    PNG_BTN,
    CLOSE_BTN,
    HELP_BTN,
    HELP_BUTN,
    HELP_READ,
    HELP_START,
    SOURCE_READ,
)

# Enhanced Messages with Emojis and Formatting
GSTART = """**‚ú®  ú·¥á è {0}, …™'·¥ç {1} ‚ú®**\n\n**üìå  è·¥è·¥ú Ä ·¥Ä·¥Ö·¥†·¥Ä…¥·¥Ñ·¥á·¥Ö ·¥Ä…™ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ**\n\n**‚Ä¢ /chatbot** - ·¥õ·¥è…¢…¢ ü·¥á ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ\n**‚Ä¢ /lang** - s·¥á·¥õ  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á\n**‚Ä¢ /ping** -  ô·¥è·¥õ s·¥õ·¥Ä·¥õ·¥ús\n**‚Ä¢ /broadcast** -  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ ·¥çs…¢\n**‚Ä¢ /id** - …¢·¥á·¥õ …™·¥Ös\n**‚Ä¢ /stats** -  ô·¥è·¥õ s·¥õ·¥Ä·¥õs\n\n**üî• ·¥ò·¥è·¥°·¥á Ä·¥á·¥Ö  ô è: @ShrutiBots**"""

STICKER = [
    "CAACAgUAAx0CYlaJawABBy4vZaieO6T-Ayg3mD-JP-f0yxJngIkAAv0JAALVS_FWQY7kbQSaI-geBA",
    "CAACAgUAAx0CYlaJawABBy4rZaid77Tf70SV_CfjmbMgdJyVD8sAApwLAALGXCFXmCx8ZC5nlfQeBA",
    "CAACAgUAAx0CYlaJawABBy4jZaidvIXNPYnpAjNnKgzaHmh3cvoAAiwIAAIda2lVNdNI2QABHuVVHgQ",
]

EMOJIOS = ["‚ö°","üî•","ü™Ñ","üí´","‚ú®","üí•","üéØ","üåü","üé©","ü¶ã"]

BOT_PIC = "https://envs.sh/IL_.jpg"
IMG = [
    "https://graph.org/file/210751796ff48991b86a3.jpg",
    "https://graph.org/file/7b4924be4179f70abcf33.jpg",
    "https://graph.org/file/f6d8e64246bddc26b4f66.jpg",
    "https://graph.org/file/63d3ec1ca2c965d6ef210.jpg",
    "https://graph.org/file/9f12dc2a668d40875deb5.jpg",
]

# Database Collections
from ChatBot import db
chatai = db.Word.WordDb
lang_db = db.ChatLangDb.LangCollection
status_db = db.ChatBotStatusDb.StatusCollection
cloneownerdb = db.clone_owners
bot_settings_db = db.bot_settings

# Default support links
DEFAULT_SUPPORT_CHANNEL = "https://t.me/ShrutiBots"
DEFAULT_SUPPORT_GROUP = "https://t.me/ShrutiBotsSupport"

async def get_clone_owner(bot_id):
    data = await cloneownerdb.find_one({"bot_id": bot_id})
    if data:
        return data["user_id"]
    return None

async def get_bot_settings(bot_id):
    """Get bot settings from database"""
    settings = await bot_settings_db.find_one({"bot_id": bot_id})
    if not settings:
        settings = {
            "bot_id": bot_id,
            "support_channel": DEFAULT_SUPPORT_CHANNEL,
            "support_group": DEFAULT_SUPPORT_GROUP,
            "custom_start_msg": None
        }
        await bot_settings_db.insert_one(settings)
    return settings

async def update_bot_settings(bot_id, key, value):
    """Update bot settings in database"""
    await bot_settings_db.update_one(
        {"bot_id": bot_id},
        {"$set": {key: value}},
        upsert=True
    )

async def bot_sys_stats():
    bot_uptime = int(time.time() - _boot_)
    cpu = psutil.cpu_percent(interval=0.5)
    mem = psutil.virtual_memory().percent
    disk = psutil.disk_usage("/").percent
    UP = f"{get_readable_time((bot_uptime))}"
    CPU = f"{cpu}%"
    RAM = f"{mem}%"
    DISK = f"{disk}%"
    return UP, CPU, RAM, DISK

async def set_default_status(chat_id):
    try:
        if not await status_db.find_one({"chat_id": chat_id}):
            await status_db.insert_one({"chat_id": chat_id, "status": "enabled"})
    except Exception as e:
        print(f"Error setting status: {e}")

@Client.on_message(filters.new_chat_members)
async def welcome_new_chat(client, message: Message):
    chat = message.chat
    bot_id = client.me.id
    await add_served_cchat(bot_id, chat.id)
    await add_served_chat(chat.id)
    await set_default_status(chat.id)
    
    # Get bot settings for support links
    settings = await get_bot_settings(bot_id)
    
    for member in message.new_chat_members:
        if member.id == client.me.id:
            try:
                # Welcome Message with Buttons including support links
                buttons = [
                    [InlineKeyboardButton("üåç s·¥á ü·¥á·¥Ñ·¥õ  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á", callback_data="choose_lang")],
                    [InlineKeyboardButton("üõ†  ú·¥á ü·¥ò", url=f"https://t.me/{client.username}?start=help")],
                    [
                        InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
                        InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
                    ]
                ]
                await message.reply_text(
                    text="**üéâ ·¥õ ú·¥Ä…¥·¥ãs “ì·¥è Ä ·¥Ä·¥Ö·¥Ö…™…¥…¢ ·¥ç·¥á!**\n\n**üìå …™'·¥ç ·¥Ä…¥ ·¥Ä·¥Ö·¥†·¥Ä…¥·¥Ñ·¥á·¥Ö ·¥Ä…™ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ**\n\n**üåü ·¥ús·¥á /lang ·¥õ·¥è s·¥á·¥õ  è·¥è·¥ú Ä ·¥Ñ ú·¥Ä·¥õ  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á**\n**üí¨ s·¥õ·¥Ä Ä·¥õ ·¥Ñ ú·¥Ä·¥õ·¥õ…™…¥…¢ ·¥°…™·¥õ ú ·¥ç·¥á!**",
                    reply_markup=InlineKeyboardMarkup(buttons)
                )
                
                # Get Chat Info for Logs
                try:
                    invitelink = await client.export_chat_invite_link(chat.id)
                    link = f"üìé […¢ Ä·¥è·¥ú·¥ò  ü…™…¥·¥ã]({invitelink})"
                except:
                    link = "üîí …¥·¥è  ü…™…¥·¥ã"
                
                chat_photo = await client.download_media(chat.photo.big_file_id) if chat.photo else BOT_PIC
                
                # Enhanced Log Message
                log_msg = (
                    f"**üìå …¥·¥á·¥° …¢ Ä·¥è·¥ú·¥ò**\n\n"
                    f"**‚Ä¢ …¥·¥Ä·¥ç·¥á:** {chat.title}\n"
                    f"**‚Ä¢ …™·¥Ö:** `{chat.id}`\n"
                    f"**‚Ä¢ ·¥ús·¥á Ä…¥·¥Ä·¥ç·¥á:** @{chat.username if chat.username else '·¥ò Ä…™·¥†·¥Ä·¥õ·¥á'}\n"
                    f"**‚Ä¢  ü…™…¥·¥ã:** {link}\n"
                    f"**‚Ä¢ ·¥ç·¥á·¥ç ô·¥á Äs:** {await client.get_chat_members_count(chat.id)}\n"
                    f"**‚Ä¢ ·¥Ä·¥Ö·¥Ö·¥á·¥Ö  ô è:** {message.from_user.mention}\n\n"
                    f"**üî• ·¥õ·¥è·¥õ·¥Ä ü ·¥Ñ ú·¥Ä·¥õs:** {len(await get_served_cchats(bot_id))}"
                )
                
                # Send to Owner
                owner_id = await get_clone_owner(bot_id)
                if owner_id:
                    await client.send_photo(
                        owner_id,
                        photo=chat_photo,
                        caption=log_msg,
                        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton(
                            f"{message.from_user.first_name}",
                            user_id=message.from_user.id
                        )]])
                    )
                
            except Exception as e:
                print(f"Welcome error: {e}")

@Client.on_message(filters.command(["setsupportchannel"]))
async def set_support_channel(client, message: Message):
    bot_id = client.me.id
    user_id = message.from_user.id
    
    # Check if user owns this bot
    if not await is_owner(bot_id, user_id):
        return await message.reply("‚ùå **You don't have permission to modify this bot!**")
    
    if len(message.command) < 2:
        return await message.reply(
            "‚ö†Ô∏è **Please provide the support channel URL**\n\n"
            "**Usage:** `/setsupportchannel https://t.me/YourChannel`\n\n"
            "**Example:** `/setsupportchannel https://t.me/ShrutiBots`"
        )
    
    channel_url = message.text.split(None, 1)[1]
    
    # Basic URL validation
    if not (channel_url.startswith("https://t.me/") or channel_url.startswith("http://t.me/")):
        return await message.reply("‚ùå **Please provide a valid Telegram channel URL!**\n\n**Example:** `https://t.me/YourChannel`")
    
    try:
        await update_bot_settings(bot_id, "support_channel", channel_url)
        await message.reply(
            f"‚úÖ **Support channel updated successfully!**\n\n"
            f"**üì¢ New Channel:** {channel_url}\n\n"
            f"**üìå Note:** This will now appear in your bot's start message buttons!"
        )
    except Exception as e:
        await message.reply(f"‚ùå **Error updating support channel:** `{str(e)[:200]}`")

@Client.on_message(filters.command(["setsupportgroup"]))
async def set_support_group(client, message: Message):
    bot_id = client.me.id
    user_id = message.from_user.id
    
    # Check if user owns this bot
    if not await is_owner(bot_id, user_id):
        return await message.reply("‚ùå **You don't have permission to modify this bot!**")
    
    if len(message.command) < 2:
        return await message.reply(
            "‚ö†Ô∏è **Please provide the support group URL**\n\n"
            "**Usage:** `/setsupportgroup https://t.me/YourGroup`\n\n"
            "**Example:** `/setsupportgroup https://t.me/ShrutiBotsSupport`"
        )
    
    group_url = message.text.split(None, 1)[1]
    
    # Basic URL validation
    if not (group_url.startswith("https://t.me/") or group_url.startswith("http://t.me/")):
        return await message.reply("‚ùå **Please provide a valid Telegram group URL!**\n\n**Example:** `https://t.me/YourGroup`")
    
    try:
        await update_bot_settings(bot_id, "support_group", group_url)
        await message.reply(
            f"‚úÖ **Support group updated successfully!**\n\n"
            f"**üë• New Group:** {group_url}\n\n"
            f"**üìå Note:** This will now appear in your bot's start message buttons!"
        )
    except Exception as e:
        await message.reply(f"‚ùå **Error updating support group:** `{str(e)[:200]}`")

@Client.on_message(filters.command(["start", "aistart"]))
async def start_command(client, message: Message):
    bot_id = client.me.id
    users = len(await get_served_cusers(bot_id))
    chats = len(await get_served_cchats(bot_id))
    
    # Get bot settings for support links
    settings = await get_bot_settings(bot_id)
    
    if message.chat.type == ChatType.PRIVATE:
        # Cool Loading Animation
        loading = await message.reply_text(random.choice(EMOJIOS))
        steps = [
            "ü§ç",
            "üíõ",
            "üíô",
            "üñ§",
        ]
        for step in steps:
            await loading.edit(step)
            await asyncio.sleep(0.2)  # Faster animation
        await loading.delete()
        
        # Send Sticker
        await message.reply_sticker(random.choice(STICKER))
        
        # Get User Photo or Default
        chat_photo = BOT_PIC
        if message.chat.photo:
            try:
                user_photo = await client.download_media(message.chat.photo.big_file_id)
                chat_photo = user_photo if user_photo else BOT_PIC
            except:
                chat_photo = BOT_PIC
        
        # System Stats
        UP, CPU, RAM, DISK = await bot_sys_stats()
        
        # Enhanced Start Message with support buttons
        start_buttons = [
            [
                InlineKeyboardButton("üî• ·¥Ä·¥Ö·¥Ö ·¥ç·¥á ·¥õ·¥è  è·¥è·¥ú Ä …¢ Ä·¥è·¥ú·¥ò", url=f"https://t.me/{client.username}?startgroup=true"),
            ],
            [
                InlineKeyboardButton("üõ†  ú·¥á ü·¥ò", callback_data="help_menu"),
                InlineKeyboardButton("üéõ ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös", callback_data="commands_menu")
            ],
            [
                InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
                InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
            ],
            [
                InlineKeyboardButton("üîí ·¥Ñ ü·¥ès·¥á", callback_data="close")
            ]
        ]
        
        enhanced_start_msg = (
            f"**‚ú®  ú·¥á ü ü·¥è {message.from_user.mention}!**\n\n"
            f"**ü§ñ …™'·¥ç {client.me.first_name} -  è·¥è·¥ú Ä ·¥Ä·¥Ö·¥†·¥Ä…¥·¥Ñ·¥á·¥Ö ·¥Ä…™ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ!**\n\n"
            f"**üìä  ô·¥è·¥õ s·¥õ·¥Ä·¥õs:**\n"
            f"**‚îú üë• ·¥ús·¥á Äs:** `{users}`\n"
            f"**‚îú üí¨ ·¥Ñ ú·¥Ä·¥õs:** `{chats}`\n"
            f"**‚îú ‚è∞ ·¥ú·¥ò·¥õ…™·¥ç·¥á:** `{UP}`\n"
            f"**‚îî üñ• ·¥Ñ·¥ò·¥ú:** `{CPU}`\n\n"
            f"**üåü “ì·¥á·¥Ä·¥õ·¥ú Ä·¥ás:**\n"
            f"**‚Ä¢ üí¨ s·¥ç·¥Ä Ä·¥õ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ**\n"
            f"**‚Ä¢ üåç ·¥ç·¥ú ü·¥õ…™- ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á s·¥ú·¥ò·¥ò·¥è Ä·¥õ**\n"
            f"**‚Ä¢ ‚ö° “ì·¥Äs·¥õ  Ä·¥ás·¥ò·¥è…¥s·¥ás**\n"
            f"**‚Ä¢ üõ† ·¥Ñ·¥ús·¥õ·¥è·¥ç…™·¥¢·¥Ä ô ü·¥á**\n\n"
            f"**üî•  Ä·¥á·¥Ä·¥Ö è ·¥õ·¥è ·¥Ñ ú·¥Ä·¥õ? ·¥ä·¥ús·¥õ s·¥á…¥·¥Ö ·¥ç·¥á ·¥Ä ·¥ç·¥áss·¥Ä…¢·¥á!**"
        )
        
        await message.reply_photo(
            photo=chat_photo,
            caption=enhanced_start_msg,
            reply_markup=InlineKeyboardMarkup(start_buttons)
        )
        await add_served_cuser(bot_id, message.chat.id)
        await add_served_user(message.chat.id)
        
        # Notify Owner with enhanced message
        owner_msg = (
            f"**üöÄ …¥·¥á·¥° ·¥ús·¥á Ä s·¥õ·¥Ä Ä·¥õ·¥á·¥Ö  ô·¥è·¥õ**\n\n"
            f"**‚Ä¢ …¥·¥Ä·¥ç·¥á:** {message.chat.first_name}\n"
            f"**‚Ä¢ ·¥ús·¥á Ä…¥·¥Ä·¥ç·¥á:** @{message.chat.username or '…¥/·¥Ä'}\n"
            f"**‚Ä¢ …™·¥Ö:** `{message.chat.id}`\n"
            f"**‚Ä¢  ü·¥Ä…¥…¢:** {message.chat.language_code or '·¥ú…¥·¥ã…¥·¥è·¥°…¥'}\n\n"
            f"**üìä ·¥õ·¥è·¥õ·¥Ä ü ·¥ús·¥á Äs:** `{users + 1}`"
        )
        owner_id = await get_clone_owner(bot_id)
        if owner_id:
            await client.send_photo(
                owner_id,
                photo=chat_photo,
                caption=owner_msg,
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton(
                    f"{message.chat.first_name}",
                    user_id=message.chat.id
                )]])
            )
    else:
        # Group Start Message with support buttons
        group_buttons = [
            [
                InlineKeyboardButton("üõ†  ú·¥á ü·¥ò", url=f"https://t.me/{client.username}?start=help"),
                InlineKeyboardButton("üéõ ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös", url=f"https://t.me/{client.username}?start=commands")
            ],
            [
                InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
                InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
            ]
        ]
        
        enhanced_group_start = (
            f"**‚ú®  ú·¥á è {message.from_user.mention}, …™'·¥ç {client.me.first_name}! ‚ú®**\n\n"
            f"**ü§ñ  è·¥è·¥ú Ä ·¥Ä·¥Ö·¥†·¥Ä…¥·¥Ñ·¥á·¥Ö ·¥Ä…™ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ ·¥°…™·¥õ ú s·¥ç·¥Ä Ä·¥õ ·¥Ñ·¥è…¥·¥†·¥á Äs·¥Ä·¥õ…™·¥è…¥s!**\n\n"
            f"**üåü ·¥ã·¥á è ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
            f"**‚Ä¢ /chatbot** - ·¥õ·¥è…¢…¢ ü·¥á ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ ·¥è…¥/·¥è“ì“ì\n"
            f"**‚Ä¢ /lang** - s·¥á·¥õ  è·¥è·¥ú Ä  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á\n"
            f"**‚Ä¢ /ping** - ·¥Ñ ú·¥á·¥Ñ·¥ã  ô·¥è·¥õ s·¥õ·¥Ä·¥õ·¥ús\n"
            f"**‚Ä¢ /stats** - ·¥†…™·¥á·¥°  ô·¥è·¥õ s·¥õ·¥Ä·¥õ…™s·¥õ…™·¥Ñs\n"
            f"**‚Ä¢ /id** - …¢·¥á·¥õ ·¥Ñ ú·¥Ä·¥õ/·¥ús·¥á Ä …™·¥Ös\n\n"
            f"**üí¨ ·¥ä·¥ús·¥õ s·¥á…¥·¥Ö ·¥Ä ·¥ç·¥áss·¥Ä…¢·¥á ·¥õ·¥è s·¥õ·¥Ä Ä·¥õ ·¥Ñ ú·¥Ä·¥õ·¥õ…™…¥…¢!**"
        )
        
        await message.reply_photo(
            photo=random.choice(IMG),
            caption=help_text,
            reply_markup=InlineKeyboardMarkup(help_buttons),
        )
    else:
        group_help_buttons = [
            [
                InlineKeyboardButton("üõ†  ú·¥á ü·¥ò", url=f"https://t.me/{client.username}?start=help"),
                InlineKeyboardButton("üéõ ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös", url=f"https://t.me/{client.username}?start=commands")
            ],
            [
                InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
                InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
            ]
        ]
        
        await message.reply_photo(
            photo=random.choice(IMG),
            caption="**üí° ·¥Ñ ü…™·¥Ñ·¥ã  ô·¥á ü·¥è·¥°  ô·¥ú·¥õ·¥õ·¥è…¥ “ì·¥è Ä ·¥Ö·¥á·¥õ·¥Ä…™ ü·¥á·¥Ö  ú·¥á ü·¥ò**\n\n**ü§ñ ·¥è Ä ·¥ä·¥ús·¥õ s·¥õ·¥Ä Ä·¥õ ·¥Ñ ú·¥Ä·¥õ·¥õ…™…¥…¢ ·¥°…™·¥õ ú ·¥ç·¥á!**",
            reply_markup=InlineKeyboardMarkup(group_help_buttons),
        )
        await add_served_cchat(bot_id, message.chat.id)
        await add_served_chat(message.chat.id)

@Client.on_message(filters.command("repo"))
async def repo_command(client, message: Message):
    settings = await get_bot_settings(client.me.id)
    
    repo_buttons = [
        [
            InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
            InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
        ],
        [InlineKeyboardButton("üîí ·¥Ñ ü·¥ès·¥á", callback_data="close")]
    ]
    
    await message.reply_text(
        text=SOURCE_READ,
        reply_markup=InlineKeyboardMarkup(repo_buttons),
        disable_web_page_preview=True,
    )

@Client.on_message(filters.command("ping"))
async def ping_command(client, message: Message):
    bot_id = client.me.id
    start = datetime.now()
    UP, CPU, RAM, DISK = await bot_sys_stats()
    settings = await get_bot_settings(bot_id)
    
    ping_msg = await message.reply_photo(
        photo=random.choice(IMG),
        caption="**üì° ·¥ò…™…¥…¢…™…¥…¢...**",
    )

    ms = (datetime.now() - start).microseconds / 1000
    
    ping_buttons = [
        [
            InlineKeyboardButton("üîÑ  Ä·¥á“ì Ä·¥ás ú", callback_data="refresh_ping"),
            InlineKeyboardButton("üìä ·¥Ö·¥á·¥õ·¥Ä…™ ü·¥á·¥Ö s·¥õ·¥Ä·¥õs", callback_data="detailed_stats")
        ],
        [
            InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
            InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
        ]
    ]
    
    await ping_msg.edit_text(
        text=(
            f"**‚ö° {client.me.first_name} s·¥õ·¥Ä·¥õs ‚ö°**\n\n"
            f"**üìä s ès·¥õ·¥á·¥ç ·¥ò·¥á Ä“ì·¥è Ä·¥ç·¥Ä…¥·¥Ñ·¥á:**\n"
            f"**‚îú üì° ·¥ò…™…¥…¢:** `{ms:.2f}` ms\n"
            f"**‚îú üñ• ·¥Ñ·¥ò·¥ú:** `{CPU}`\n"
            f"**‚îú üíæ  Ä·¥Ä·¥ç:** `{RAM}`\n"
            f"**‚îú üíø ·¥Ö…™s·¥ã:** `{DISK}`\n"
            f"**‚îî ‚è∞ ·¥ú·¥ò·¥õ…™·¥ç·¥á:** `{UP}`\n\n"
            f"**üöÄ s·¥õ·¥Ä·¥õ·¥ús:** {'üü¢ ·¥è…¥ ü…™…¥·¥á' if ms < 100 else 'üü° s ü·¥è·¥°' if ms < 200 else 'üî¥  ü·¥Ä…¢…¢…™…¥…¢'}\n\n"
            f"**üî• ·¥ò·¥è·¥°·¥á Ä·¥á·¥Ö  ô è: @ShrutiBots**"
        ),
        reply_markup=InlineKeyboardMarkup(ping_buttons)
    )

@Client.on_callback_query(filters.regex("refresh_stats"))
async def refresh_stats_callback(client, callback_query: CallbackQuery):
    bot_id = client.me.id
    users = len(await get_served_cusers(bot_id))
    chats = len(await get_served_cchats(bot_id))
    settings = await get_bot_settings(bot_id)
    UP, CPU, RAM, DISK = await bot_sys_stats()
    
    stats_buttons = [
        [
            InlineKeyboardButton("üîÑ  Ä·¥á“ì Ä·¥ás ú", callback_data="refresh_stats"),
            InlineKeyboardButton("üìà …¢ Ä·¥è·¥°·¥õ ú", callback_data="growth_stats")
        ],
        [
            InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
            InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
        ]
    ]
    
    stats_text = (
        f"**üìä {client.me.first_name} s·¥õ·¥Ä·¥õ…™s·¥õ…™·¥Ñs**\n\n"
        f"**üë• ·¥ús·¥á Ä s·¥õ·¥Ä·¥õs:**\n"
        f"**‚îú üë§ ·¥õ·¥è·¥õ·¥Ä ü ·¥ús·¥á Äs:** `{users:,}`\n"
        f"**‚îî üí¨ ·¥õ·¥è·¥õ·¥Ä ü ·¥Ñ ú·¥Ä·¥õs:** `{chats:,}`\n\n"
        f"**‚ö° s ès·¥õ·¥á·¥ç s·¥õ·¥Ä·¥õs:**\n"
        f"**‚îú ‚è∞ ·¥ú·¥ò·¥õ…™·¥ç·¥á:** `{UP}`\n"
        f"**‚îú üñ• ·¥Ñ·¥ò·¥ú:** `{CPU}`\n"
        f"**‚îú üíæ  Ä·¥Ä·¥ç:** `{RAM}`\n"
        f"**‚îî üíø ·¥Ö…™s·¥ã:** `{DISK}`\n\n"
        f"**üåü ·¥õ·¥è·¥õ·¥Ä ü …™…¥·¥õ·¥á Ä·¥Ä·¥Ñ·¥õ…™·¥è…¥s:** `{users + chats:,}`\n\n"
        f"**üî• ·¥ò·¥è·¥°·¥á Ä·¥á·¥Ö  ô è: @ShrutiBots**"
    )
    
    await callback_query.edit_message_text(
        text=stats_text,
        reply_markup=InlineKeyboardMarkup(stats_buttons)
    )

# Additional Callback Handlers for enhanced functionality
@Client.on_callback_query(filters.regex("help_menu"))
async def help_menu_callback(client, callback_query: CallbackQuery):
    settings = await get_bot_settings(client.me.id)
    
    help_buttons = [
        [
            InlineKeyboardButton("ü§ñ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ", callback_data="help_chatbot"),
            InlineKeyboardButton("üåç  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á", callback_data="help_language")
        ],
        [
            InlineKeyboardButton("üìä s·¥õ·¥Ä·¥õs", callback_data="help_stats"),
            InlineKeyboardButton("üõ† ·¥Ä·¥Ö·¥ç…™…¥", callback_data="help_admin")
        ],
        [
            InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
            InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
        ],
        [InlineKeyboardButton("üîí ·¥Ñ ü·¥ès·¥á", callback_data="close")]
    ]
    
    help_text = (
        f"**üõ†  ú·¥á ü·¥ò ·¥ç·¥á…¥·¥ú - {client.me.first_name}**\n\n"
        f"**ü§ñ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
        f"‚Ä¢ `/chatbot` - ·¥á…¥·¥Ä ô ü·¥á/·¥Ö…™s·¥Ä ô ü·¥á ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ\n"
        f"‚Ä¢ `/status` - ·¥Ñ ú·¥á·¥Ñ·¥ã ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ s·¥õ·¥Ä·¥õ·¥ús\n\n"
        f"**üåç  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
        f"‚Ä¢ `/lang` - s·¥á·¥õ  ô·¥è·¥õ  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á\n"
        f"‚Ä¢ `/chatlang` - ·¥Ñ ú·¥á·¥Ñ·¥ã ·¥Ñ·¥ú Ä Ä·¥á…¥·¥õ  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á\n"
        f"‚Ä¢ `/resetlang` -  Ä·¥ás·¥á·¥õ ·¥õ·¥è ·¥Ö·¥á“ì·¥Ä·¥ú ü·¥õ\n\n"
        f"**üìä …™…¥“ì·¥è ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
        f"‚Ä¢ `/ping` - ·¥Ñ ú·¥á·¥Ñ·¥ã  ô·¥è·¥õ s·¥õ·¥Ä·¥õ·¥ús\n"
        f"‚Ä¢ `/stats` - ·¥†…™·¥á·¥°  ô·¥è·¥õ s·¥õ·¥Ä·¥õ…™s·¥õ…™·¥Ñs\n"
        f"‚Ä¢ `/id` - …¢·¥á·¥õ ·¥Ñ ú·¥Ä·¥õ/·¥ús·¥á Ä …™·¥Ös\n\n"
        f"**üí¨ ·¥ä·¥ús·¥õ s·¥á…¥·¥Ö ·¥Ä ·¥ç·¥áss·¥Ä…¢·¥á ·¥õ·¥è s·¥õ·¥Ä Ä·¥õ ·¥Ñ ú·¥Ä·¥õ·¥õ…™…¥…¢!**"
    )
    
    await callback_query.edit_message_text(
        text=help_text,
        reply_markup=InlineKeyboardMarkup(help_buttons)
    )

@Client.on_callback_query(filters.regex("commands_menu"))
async def commands_menu_callback(client, callback_query: CallbackQuery):
    settings = await get_bot_settings(client.me.id)
    
    commands_buttons = [
        [
            InlineKeyboardButton("üîô  ô·¥Ä·¥Ñ·¥ã", callback_data="help_menu"),
            InlineKeyboardButton("üîí ·¥Ñ ü·¥ès·¥á", callback_data="close")
        ],
        [
            InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
            InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
        ]
    ]
    
    commands_text = (
        f"**üéõ ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ö  ü…™s·¥õ - {client.me.first_name}**\n\n"
        f"**üî∞  ô·¥Äs…™·¥Ñ ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
        f"‚Ä¢ `/start` - s·¥õ·¥Ä Ä·¥õ ·¥õ ú·¥á  ô·¥è·¥õ\n"
        f"‚Ä¢ `/help` - s ú·¥è·¥°  ú·¥á ü·¥ò ·¥ç·¥á…¥·¥ú\n"
        f"‚Ä¢ `/ping` - ·¥Ñ ú·¥á·¥Ñ·¥ã  ô·¥è·¥õ  ü·¥Ä·¥õ·¥á…¥·¥Ñ è\n"
        f"‚Ä¢ `/stats` - ·¥†…™·¥á·¥°  ô·¥è·¥õ s·¥õ·¥Ä·¥õ…™s·¥õ…™·¥Ñs\n"
        f"‚Ä¢ `/id` - …¢·¥á·¥õ ·¥Ñ ú·¥Ä·¥õ/·¥ús·¥á Ä …™·¥Ös\n\n"
        f"**ü§ñ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
        f"‚Ä¢ `/chatbot` - ·¥õ·¥è…¢…¢ ü·¥á ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ\n"
        f"‚Ä¢ `/status` - ·¥Ñ ú·¥á·¥Ñ·¥ã ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ s·¥õ·¥Ä·¥õ·¥ús\n"
        f"‚Ä¢ `/ask <«´·¥ú·¥ás·¥õ…™·¥è…¥>` - ·¥Äs·¥ã ·¥Ä…™\n\n"
        f"**üåç  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
        f"‚Ä¢ `/lang` - s·¥á·¥õ  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á\n"
        f"‚Ä¢ `/chatlang` - ·¥Ñ ú·¥á·¥Ñ·¥ã ·¥Ñ·¥ú Ä Ä·¥á…¥·¥õ  ü·¥Ä…¥…¢\n"
        f"‚Ä¢ `/resetlang` -  Ä·¥ás·¥á·¥õ  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á\n\n"
        f"**üõ† ·¥è·¥°…¥·¥á Ä ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
        f"‚Ä¢ `/broadcast` -  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ ·¥ç·¥áss·¥Ä…¢·¥á\n"
        f"‚Ä¢ `/setsupportchannel` - s·¥á·¥õ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü\n"
        f"‚Ä¢ `/setsupportgroup` - s·¥á·¥õ s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò\n\n"
        f"**üí¨ ·¥ä·¥ús·¥õ ·¥õ è·¥ò·¥á ·¥Ä…¥ è·¥õ ú…™…¥…¢ ·¥õ·¥è ·¥Ñ ú·¥Ä·¥õ ·¥°…™·¥õ ú ·¥ç·¥á!**"
    )
    
    await callback_query.edit_message_text(
        text=commands_text,
        reply_markup=InlineKeyboardMarkup(commands_buttons)
    )

# Utility Function
def humanbytes(size: int) -> str:
    """Convert bytes to human readable format"""
    if not size:
        return "0 B"
    power = 2**10
    n = 0
    units = {0: "B", 1: "KB", 2: "MB", 3: "GB", 4: "TB"}
    while size > power:
        size /= power
        n += 1
    return f"{round(size, 2)} {units[n]}"

# Enhanced error handling
async def handle_error(client, message, error):
    """Enhanced error handler"""
    error_msg = (
        f"**‚ùå ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä Ä·¥á·¥Ö**\n\n"
        f"**‚Ä¢ ·¥á Ä Ä·¥è Ä:** `{str(error)[:200]}`\n"
        f"**‚Ä¢ ·¥Ñ ú·¥Ä·¥õ:** `{message.chat.id}`\n"
        f"**‚Ä¢ ·¥ús·¥á Ä:** `{message.from_user.id}`\n\n"
        f"**üîß …™“ì ·¥õ ú…™s ·¥ò·¥á Äs…™s·¥õs, ·¥Ñ·¥è…¥·¥õ·¥Ä·¥Ñ·¥õ s·¥ú·¥ò·¥ò·¥è Ä·¥õ**"
    )
    
    try:
        settings = await get_bot_settings(client.me.id)
        error_buttons = [
            [
                InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
                InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
            ]
        ]
        await message.reply(error_msg, reply_markup=InlineKeyboardMarkup(error_buttons))
    except:
        await message.reply(error_msg[:1000])

# Logging Setup
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler("chatbot.log"),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# Success message
logger.info("üéâ Start.py loaded successfully with enhanced features!  ô è: @ShrutiBots**")
    
    if message.chat.type == ChatType.PRIVATE:
        await add_served_cuser(bot_id, message.from_user.id)
        await add_served_user(message.from_user.id)
    else:
        await add_served_cchat(bot_id, message.chat.id)
        await add_served_chat(message.chat.id)

@Client.on_message(filters.command("stats"))
async def stats_command(client, message: Message):
    bot_id = client.me.id
    users = len(await get_served_cusers(bot_id))
    chats = len(await get_served_cchats(bot_id))
    settings = await get_bot_settings(bot_id)
    UP, CPU, RAM, DISK = await bot_sys_stats()
    
    stats_buttons = [
        [
            InlineKeyboardButton("üîÑ  Ä·¥á“ì Ä·¥ás ú", callback_data="refresh_stats"),
            InlineKeyboardButton("üìà …¢ Ä·¥è·¥°·¥õ ú", callback_data="growth_stats")
        ],
        [
            InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
            InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
        ]
    ]
    
    stats_text = (
        f"**üìä {client.me.first_name} s·¥õ·¥Ä·¥õ…™s·¥õ…™·¥Ñs**\n\n"
        f"**üë• ·¥ús·¥á Ä s·¥õ·¥Ä·¥õs:**\n"
        f"**‚îú üë§ ·¥õ·¥è·¥õ·¥Ä ü ·¥ús·¥á Äs:** `{users:,}`\n"
        f"**‚îî üí¨ ·¥õ·¥è·¥õ·¥Ä ü ·¥Ñ ú·¥Ä·¥õs:** `{chats:,}`\n\n"
        f"**‚ö° s ès·¥õ·¥á·¥ç s·¥õ·¥Ä·¥õs:**\n"
        f"**‚îú ‚è∞ ·¥ú·¥ò·¥õ…™·¥ç·¥á:** `{UP}`\n"
        f"**‚îú üñ• ·¥Ñ·¥ò·¥ú:** `{CPU}`\n"
        f"**‚îú üíæ  Ä·¥Ä·¥ç:** `{RAM}`\n"
        f"**‚îî üíø ·¥Ö…™s·¥ã:** `{DISK}`\n\n"
        f"**üåü ·¥õ·¥è·¥õ·¥Ä ü …™…¥·¥õ·¥á Ä·¥Ä·¥Ñ·¥õ…™·¥è…¥s:** `{users + chats:,}`\n\n"
        f"**üî• ·¥ò·¥è·¥°·¥á Ä·¥á·¥Ö  ô è: @ShrutiBots**"
    )
    
    await message.reply_photo(
        photo=random.choice(IMG),
        caption=stats_text,
        reply_markup=InlineKeyboardMarkup(stats_buttons)
    )

@Client.on_message(filters.command("id"))
async def get_id(client, message: Message):
    chat = message.chat
    user_id = message.from_user.id
    msg_id = message.id
    reply = message.reply_to_message

    text = f"**üìå …™·¥Ö …™…¥“ì·¥è Ä·¥ç·¥Ä·¥õ…™·¥è…¥**\n\n"
    text += f"**üÜî  ô·¥Äs…™·¥Ñ …™·¥Ös:**\n"
    text += f"**‚îú üí¨ ·¥ç·¥áss·¥Ä…¢·¥á …™·¥Ö:** `{msg_id}`\n"
    text += f"**‚îú üë§  è·¥è·¥ú Ä …™·¥Ö:** `{user_id}`\n"
    text += f"**‚îî üè† ·¥Ñ ú·¥Ä·¥õ …™·¥Ö:** `{chat.id}`\n\n"

    if len(message.command) == 2:
        try:
            user = message.text.split(None, 1)[1].strip()
            user_info = await client.get_users(user)
            text += f"**üîç  ü·¥è·¥è·¥ã·¥á·¥Ö ·¥ú·¥ò ·¥ús·¥á Ä:**\n"
            text += f"**‚îú üë§ …¥·¥Ä·¥ç·¥á:** {user_info.first_name}\n"
            text += f"**‚îú üÜî ·¥ús·¥á Ä …™·¥Ö:** `{user_info.id}`\n"
            text += f"**‚îî üìõ ·¥ús·¥á Ä…¥·¥Ä·¥ç·¥á:** @{user_info.username or '…¥/·¥Ä'}\n\n"
        except:
            text += "**‚ö†Ô∏è ·¥ús·¥á Ä …¥·¥è·¥õ “ì·¥è·¥ú…¥·¥Ö**\n\n"

    if reply:
        text += f"**‚Ü©Ô∏è  Ä·¥á·¥ò ü…™·¥á·¥Ö ·¥ç·¥áss·¥Ä…¢·¥á …™…¥“ì·¥è:**\n"
        text += f"**‚îú üí¨ ·¥çs…¢ …™·¥Ö:** `{reply.id}`\n"
        if reply.from_user:
            text += f"**‚îú üë§ ·¥ús·¥á Ä …™·¥Ö:** `{reply.from_user.id}`\n"
            text += f"**‚îî üìõ ·¥ús·¥á Ä…¥·¥Ä·¥ç·¥á:** @{reply.from_user.username or '…¥/·¥Ä'}\n"
        if reply.forward_from_chat:
            text += f"**‚îî üì§ “ì·¥è Ä·¥°·¥Ä Ä·¥Ö·¥á·¥Ö “ì Ä·¥è·¥ç:** `{reply.forward_from_chat.id}`\n"
        if reply.sender_chat:
            text += f"**‚îî üì¢ s·¥á…¥·¥Ö·¥á Ä ·¥Ñ ú·¥Ä·¥õ:** `{reply.sender_chat.id}`"

    await message.reply_text(text, disable_web_page_preview=True)

# Broadcast Command (Optimized)
@Client.on_message(filters.command(["broadcast", "gcast"]))
async def broadcast_command(client, message: Message):
    bot_id = client.me.id
    user_id = message.from_user.id
    
    if not await is_owner(bot_id, user_id):
        return await message.reply("‚ö†Ô∏è ** è·¥è·¥ú ·¥Ö·¥è…¥'·¥õ  ú·¥Ä·¥†·¥á ·¥ò·¥á Ä·¥ç…™ss…™·¥è…¥ ·¥õ·¥è ·¥ús·¥á ·¥õ ú…™s ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ö**")
        
    if not message.reply_to_message and len(message.command) < 2:
        return await message.reply(
            "**üì¢  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ö ·¥ús·¥Ä…¢·¥á:**\n\n"
            "**1.**  Ä·¥á·¥ò ü è ·¥õ·¥è ·¥Ä ·¥ç·¥áss·¥Ä…¢·¥á ·¥°…™·¥õ ú `/broadcast`\n"
            "**2.** ·¥è Ä ·¥ús·¥á `/broadcast < è·¥è·¥ú Ä ·¥ç·¥áss·¥Ä…¢·¥á>`\n\n"
            "**üéõ ·¥Ä·¥†·¥Ä…™ ü·¥Ä ô ü·¥á “ì ü·¥Ä…¢s:**\n"
            "‚Ä¢ `-pin` - ·¥ò…™…¥ ·¥ç·¥áss·¥Ä…¢·¥á s…™ ü·¥á…¥·¥õ ü è\n"
            "‚Ä¢ `-pinloud` - ·¥ò…™…¥ ·¥°…™·¥õ ú …¥·¥è·¥õ…™“ì…™·¥Ñ·¥Ä·¥õ…™·¥è…¥\n"
            "‚Ä¢ `-user` - s·¥á…¥·¥Ö ·¥õ·¥è ·¥ús·¥á Äs ·¥è…¥ ü è\n"
            "‚Ä¢ `-nogroup` - s·¥ã…™·¥ò …¢ Ä·¥è·¥ú·¥òs"
        )

    query = message.text.split(None, 1)[1] if len(message.command) > 1 else ""
    flags = {
        "-pin": "-pin" in query,
        "-pinloud": "-pinloud" in query,
        "-nogroup": "-nogroup" in query,
        "-user": "-user" in query,
    }

    content = message.reply_to_message if message.reply_to_message else query.replace("-pin", "").replace("-pinloud", "").replace("-nogroup", "").replace("-user", "").strip()

    if not content:
        return await message.reply("‚ö†Ô∏è **…¥·¥è ·¥Ñ·¥è…¥·¥õ·¥á…¥·¥õ “ì·¥è·¥ú…¥·¥Ö ·¥õ·¥è  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ**")

    processing = await message.reply("**üì°  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ s·¥õ·¥Ä Ä·¥õ·¥á·¥Ö...**")

    # Broadcast to Groups
    if not flags.get("-nogroup"):
        sent_groups = 0
        failed_groups = 0
        pinned_groups = 0
        groups = await get_served_cchats(bot_id)
        total_groups = len(groups)
        
        for i, group in enumerate(groups):
            try:
                if message.reply_to_message:
                    msg = await client.forward_messages(
                        group["chat_id"],
                        message.chat.id,
                        message.reply_to_message.id
                    )
                else:
                    msg = await client.send_message(
                        group["chat_id"],
                        content
                    )
                sent_groups += 1

                if flags.get("-pin") or flags.get("-pinloud"):
                    try:
                        await msg.pin(disable_notification=flags.get("-pin"))
                        pinned_groups += 1
                    except:
                        pass
                
                # Update progress every 10 groups
                if (i + 1) % 10 == 0:
                    await processing.edit(f"**üì°  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ…™…¥…¢...**\n\n**üìä ·¥ò Ä·¥è…¢ Ä·¥áss:** `{i + 1}/{total_groups}`\n**‚úÖ s·¥ú·¥Ñ·¥Ñ·¥áss:** `{sent_groups}`")
                
                await asyncio.sleep(0.1)  # Faster sending
            except FloodWait as e:
                await asyncio.sleep(e.value)
            except:
                failed_groups += 1
                continue

        result_text = f"**‚úÖ …¢ Ä·¥è·¥ú·¥ò  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ ·¥Ñ·¥è·¥ç·¥ò ü·¥á·¥õ·¥á·¥Ö!**\n\n"
        result_text += f"**üìä  Ä·¥ás·¥ú ü·¥õs:**\n"
        result_text += f"**‚îú ‚úÖ s·¥á…¥·¥õ:** `{sent_groups}`\n"
        result_text += f"**‚îú ‚ùå “ì·¥Ä…™ ü·¥á·¥Ö:** `{failed_groups}`\n"
        result_text += f"**‚îî üìå ·¥ò…™…¥…¥·¥á·¥Ö:** `{pinned_groups}`"
        
        await processing.edit(result_text)

    # Broadcast to Users
    if flags.get("-user"):
        sent_users = 0
        failed_users = 0
        users = await get_served_cusers(bot_id)
        total_users = len(users)
        
        user_processing = await message.reply("**üë•  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ…™…¥…¢ ·¥õ·¥è ·¥ús·¥á Äs...**")
        
        for i, user in enumerate(users):
            try:
                if message.reply_to_message:
                    await client.forward_messages(
                        user["user_id"],
                        message.chat.id,
                        message.reply_to_message.id
                    )
                else:
                    await client.send_message(
                        user["user_id"],
                        content
                    )
                sent_users += 1
                
                # Update progress every 20 users
                if (i + 1) % 20 == 0:
                    await user_processing.edit(f"**üë• ·¥ús·¥á Ä  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ...**\n\n**üìä ·¥ò Ä·¥è…¢ Ä·¥áss:** `{i + 1}/{total_users}`\n**‚úÖ s·¥ú·¥Ñ·¥Ñ·¥áss:** `{sent_users}`")
                
                await asyncio.sleep(0.05)  # Faster for users
            except FloodWait as e:
                await asyncio.sleep(e.value)
            except:
                failed_users += 1
                continue

        user_result = f"**‚úÖ ·¥ús·¥á Ä  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ ·¥Ñ·¥è·¥ç·¥ò ü·¥á·¥õ·¥á·¥Ö!**\n\n"
        user_result += f"**üìä  Ä·¥ás·¥ú ü·¥õs:**\n"
        user_result += f"**‚îú ‚úÖ s·¥á…¥·¥õ:** `{sent_users}`\n"
        user_result += f"**‚îî ‚ùå “ì·¥Ä…™ ü·¥á·¥Ö:** `{failed_users}`"
        
        await user_processing.edit(user_result)

# File Manager Commands (Owner Only)
@Client.on_message(filters.command(["ls"]) & filters.user(int(OWNER_ID)))
async def list_files(_, m: Message):
    """List all files and folders."""
    path = "".join(m.text.split(maxsplit=1)[1:]) if len(m.command) > 1 else os.getcwd()
    
    if not os.path.exists(path):
        return await m.reply_text(f"**‚ö†Ô∏è ·¥ò·¥Ä·¥õ ú …¥·¥è·¥õ “ì·¥è·¥ú…¥·¥Ö:** `{path}`")

    if os.path.isdir(path):
        msg = f"**üìÇ ·¥Ñ·¥è…¥·¥õ·¥á…¥·¥õs ·¥è“ì `{path}`:**\n\n"
        files = []
        folders = []
        
        for item in sorted(os.listdir(path)):
            item_path = os.path.join(path, item)
            if os.path.isdir(item_path):
                folders.append(f"üìÅ `{item}`")
            else:
                ext = os.path.splitext(item)[1].lower()
                if ext in (".mp3", ".flac", ".wav", ".m4a"):
                    files.append(f"üéµ `{item}`")
                elif ext == ".opus":
                    files.append(f"üéô `{item}`")
                elif ext in (".mkv", ".mp4", ".webm", ".avi", ".mov", ".flv"):
                    files.append(f"üéû `{item}`")
                elif ext in (".zip", ".tar", ".tar.gz", ".rar"):
                    files.append(f"üóú `{item}`")
                elif ext in (".jpg", ".jpeg", ".png", ".gif", ".bmp", ".ico"):
                    files.append(f"üñº `{item}`")
                elif ext in (".py", ".js", ".html", ".css", ".json"):
                    files.append(f"üíª `{item}`")
                elif ext in (".txt", ".md", ".log"):
                    files.append(f"üìù `{item}`")
                else:
                    files.append(f"üìÑ `{item}`")
        
        msg += "\n".join(folders + files) if folders or files else "**üìÇ ·¥á·¥ç·¥ò·¥õ è ·¥Ö…™ Ä·¥á·¥Ñ·¥õ·¥è Ä è**"
    else:
        size = os.stat(path).st_size
        ext = os.path.splitext(path)[1].lower()
        
        # File type icons
        icon_map = {
            (".mp3", ".flac", ".wav", ".m4a"): "üéµ",
            (".opus",): "üéô",
            (".mkv", ".mp4", ".webm", ".avi", ".mov", ".flv"): "üéû",
            (".zip", ".tar", ".tar.gz", ".rar"): "üóú",
            (".jpg", ".jpeg", ".png", ".gif", ".bmp", ".ico"): "üñº",
            (".py", ".js", ".html", ".css", ".json"): "üíª",
            (".txt", ".md", ".log"): "üìù"
        }
        
        icon = "üìÑ"  # default
        for extensions, file_icon in icon_map.items():
            if ext in extensions:
                icon = file_icon
                break
        
        msg = (
            f"**üìå “ì…™ ü·¥á …™…¥“ì·¥è Ä·¥ç·¥Ä·¥õ…™·¥è…¥**\n\n"
            f"**‚Ä¢ …¥·¥Ä·¥ç·¥á:** `{os.path.basename(path)}`\n"
            f"**‚Ä¢ ·¥õ è·¥ò·¥á:** {icon}\n"
            f"**‚Ä¢ s…™·¥¢·¥á:** `{humanbytes(size)}`\n"
            f"**‚Ä¢ ·¥ò·¥Ä·¥õ ú:** `{path}`\n"
            f"**‚Ä¢ ·¥ç·¥è·¥Ö…™“ì…™·¥á·¥Ö:** `{time.ctime(os.path.getmtime(path))}`\n"
            f"**‚Ä¢ ·¥Ä·¥Ñ·¥Ñ·¥áss·¥á·¥Ö:** `{time.ctime(os.path.getatime(path))}`"
        )

    if len(msg) > 4096:
        with io.BytesIO(str.encode(msg)) as file:
            file.name = "file_list.txt"
            await m.reply_document(file, caption=f"**üìÇ ·¥ò·¥Ä·¥õ ú:** `{path}`")
    else:
        await m.reply_text(msg)

# Callback Query Handlers
@Client.on_callback_query(filters.regex("close"))
async def close_callback(client, callback_query: CallbackQuery):
    await callback_query.message.delete()

@Client.on_callback_query(filters.regex("refresh_ping"))
async def refresh_ping_callback(client, callback_query: CallbackQuery):
    start = datetime.now()
    UP, CPU, RAM, DISK = await bot_sys_stats()
    ms = (datetime.now() - start).microseconds / 1000
    settings = await get_bot_settings(client.me.id)
    
    ping_buttons = [
        [
            InlineKeyboardButton("üîÑ  Ä·¥á“ì Ä·¥ás ú", callback_data="refresh_ping"),
            InlineKeyboardButton("üìä ·¥Ö·¥á·¥õ·¥Ä…™ ü·¥á·¥Ö s·¥õ·¥Ä·¥õs", callback_data="detailed_stats")
        ],
        [
            InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
            InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
        ]
    ]
    
    await callback_query.edit_message_text(
        text=(
            f"**‚ö° {client.me.first_name} s·¥õ·¥Ä·¥õs ‚ö°**\n\n"
            f"**üìä s ès·¥õ·¥á·¥ç ·¥ò·¥á Ä“ì·¥è Ä·¥ç·¥Ä…¥·¥Ñ·¥á:**\n"
            f"**‚îú üì° ·¥ò…™…¥…¢:** `{ms:.2f}` ms\n"
            f"**‚îú üñ• ·¥Ñ·¥ò·¥ú:** `{CPU}`\n"
            f"**‚îú üíæ  Ä·¥Ä·¥ç:** `{RAM}`\n"
            f"**‚îú üíø ·¥Ö…™s·¥ã:** `{DISK}`\n"
            f"**‚îî ‚è∞ ·¥ú·¥ò·¥õ…™·¥ç·¥á:** `{UP}`\n\n"
            f"**üöÄ s·¥õ·¥Ä·¥õ·¥ús:** {'üü¢ ·¥è…¥ ü…™…¥·¥á' if ms < 100 else 'üü° s ü·¥è·¥°' if ms < 200 else 'üî¥  ü·¥Ä…¢…¢…™…¥…¢'}\n\n"
            f"**üî• ·¥ò·¥è·¥°·¥á Ä·¥á·¥Ö  ·¥ä·¥ús·¥õ ·¥õ·¥Ä…¢ ·¥ç·¥á ·¥è Ä  Ä·¥á·¥ò ü è ·¥õ·¥è s·¥õ·¥Ä Ä·¥õ ·¥Ñ ú·¥Ä·¥õ·¥õ…™…¥…¢!**\n\n"
            f"**üî• ·¥ò·¥è·¥°·¥á Ä·¥á·¥Ö  ô è: @ShrutiBots**"
        )
        
        await message.reply_photo(
            photo=random.choice(IMG),
            caption=enhanced_group_start,
            reply_markup=InlineKeyboardMarkup(group_buttons),
        )
        await add_served_cchat(bot_id, message.chat.id)
        await add_served_chat(message.chat.id)

@Client.on_message(filters.command("help"))
async def help_command(client, message: Message):
    bot_id = client.me.id
    settings = await get_bot_settings(bot_id)
    
    if message.chat.type == ChatType.PRIVATE:
        help_buttons = [
            [
                InlineKeyboardButton("ü§ñ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ", callback_data="help_chatbot"),
                InlineKeyboardButton("üåç  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á", callback_data="help_language")
            ],
            [
                InlineKeyboardButton("üìä s·¥õ·¥Ä·¥õs", callback_data="help_stats"),
                InlineKeyboardButton("üõ† ·¥Ä·¥Ö·¥ç…™…¥", callback_data="help_admin")
            ],
            [
                InlineKeyboardButton("üì¢ s·¥ú·¥ò·¥ò·¥è Ä·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü", url=settings['support_channel']),
                InlineKeyboardButton("üë• s·¥ú·¥ò·¥ò·¥è Ä·¥õ …¢ Ä·¥è·¥ú·¥ò", url=settings['support_group'])
            ],
            [InlineKeyboardButton("üîí ·¥Ñ ü·¥ès·¥á", callback_data="close")]
        ]
        
        help_text = (
            f"**üõ†  ú·¥á ü·¥ò ·¥ç·¥á…¥·¥ú - {client.me.first_name}**\n\n"
            f"**ü§ñ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
            f"‚Ä¢ `/chatbot` - ·¥á…¥·¥Ä ô ü·¥á/·¥Ö…™s·¥Ä ô ü·¥á ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ\n"
            f"‚Ä¢ `/status` - ·¥Ñ ú·¥á·¥Ñ·¥ã ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ s·¥õ·¥Ä·¥õ·¥ús\n\n"
            f"**üåç  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
            f"‚Ä¢ `/lang` - s·¥á·¥õ  ô·¥è·¥õ  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á\n"
            f"‚Ä¢ `/chatlang` - ·¥Ñ ú·¥á·¥Ñ·¥ã ·¥Ñ·¥ú Ä Ä·¥á…¥·¥õ  ü·¥Ä…¥…¢·¥ú·¥Ä…¢·¥á\n"
            f"‚Ä¢ `/resetlang` -  Ä·¥ás·¥á·¥õ ·¥õ·¥è ·¥Ö·¥á“ì·¥Ä·¥ú ü·¥õ\n\n"
            f"**üìä …™…¥“ì·¥è ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ös:**\n"
            f"‚Ä¢ `/ping` - ·¥Ñ ú·¥á·¥Ñ·¥ã  ô·¥è·¥õ s·¥õ·¥Ä·¥õ·¥ús\n"
            f"‚Ä¢ `/stats` - ·¥†…™·¥á·¥°  ô·¥è·¥õ s·¥õ·¥Ä·¥õ…™s·¥õ…™·¥Ñs\n"
            f"‚Ä¢ `/id` - …¢·¥á·¥õ ·¥Ñ ú·¥Ä·¥õ/·¥ús·¥á Ä …™·¥Ös\n\n"
            f"**üí¨
